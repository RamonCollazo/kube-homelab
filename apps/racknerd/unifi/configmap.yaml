---
apiVersion: v1
kind: ConfigMap
metadata:
  name: unifi-env
  namespace: unifi
data:
  PUID: "1000"
  PGID: "1000"
  TZ: "America/Puerto_Rico"
  MONGO_USER: "unifi"
  MONGO_HOST: "unifi-db-svc.mongodb.svc.cluster.local"
  MONGO_PORT: "27017"
  MONGO_DBNAME: "unifi"
  MONGO_AUTHSOURCE: unifi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: unifi-cert-import
  namespace: unifi
data:
  import-cert.sh: |
    #!/bin/bash
    CERT=/config/keys/cert.crt
    KEY=/config/keys/privkey.pem
    KEYSTORE=/config/data/keystore
    PASS=aircontrolenterprise

    if [[ ! -f "$CERT" || ! -f "$KEY" ]]; then
      echo "[cert-import] No custom cert found, skipping."
      exit 0
    fi

    echo "[cert-import] Importing LE cert into Unifi keystore..."
    openssl pkcs12 -export \
      -in "$CERT" \
      -inkey "$KEY" \
      -out /tmp/unifi.p12 \
      -name unifi \
      -passout pass:"$PASS"

    keytool -delete \
      -alias unifi \
      -keystore "$KEYSTORE" \
      -storepass "$PASS" \
      -noprompt 2>/dev/null || true

    keytool -importkeystore \
      -srckeystore /tmp/unifi.p12 \
      -srcstoretype PKCS12 \
      -srcstorepass "$PASS" \
      -destkeystore "$KEYSTORE" \
      -deststorepass "$PASS" \
      -alias unifi \
      -noprompt

    rm /tmp/unifi.p12
    echo "[cert-import] Done."
